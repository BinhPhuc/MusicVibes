import './polyfills.server.mjs';
import{a as p,b as S,h as B,i as n}from"./chunk-QYG7H2UI.mjs";var R="End-Of-Stream",o=class extends Error{constructor(){super(R),this.name="EndOfStreamError"}},h=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var l=class{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}peek(e,t=!1){return n(this,null,function*(){let r=yield this.read(e,t);return this.peekQueue.push(e.subarray(0,r)),r})}read(e,t=!1){return n(this,null,function*(){if(e.length===0)return 0;let r=this.readFromPeekBuffer(e);if(this.endOfStream||(r+=yield this.readRemainderFromStream(e.subarray(r),t)),r===0)throw new o;return r})}readFromPeekBuffer(e){let t=e.length,r=0;for(;this.peekQueue.length>0&&t>0;){let s=this.peekQueue.pop();if(!s)throw new Error("peekData should be defined");let i=Math.min(s.length,t);e.set(s.subarray(0,i),r),r+=i,t-=i,i<s.length&&this.peekQueue.push(s.subarray(i))}return r}readRemainderFromStream(e,t){return n(this,null,function*(){let r=0;for(;r<e.length&&!this.endOfStream;){if(this.interrupted)throw new h;let s=yield this.readFromStream(e.subarray(r),t);if(s===0)break;r+=s}if(!t&&r<e.length)throw new o;return r})}};var w=class extends l{constructor(e){super(),this.reader=e}abort(){return n(this,null,function*(){return this.close()})}close(){return n(this,null,function*(){this.reader.releaseLock()})}};var d=class extends w{readFromStream(e,t){return n(this,null,function*(){if(e.length===0)return 0;let r=yield this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return r.done&&(this.endOfStream=r.done),r.value?(e.set(r.value),r.value.length):0})}};var c=class extends l{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){let r=Math.min(t.length,e.length);return e.set(t.subarray(0,r)),r<t.length?this.buffer=t.subarray(r):this.buffer=null,r}readFromStream(e,t){return n(this,null,function*(){if(e.length===0)return 0;let r=0;for(this.buffer&&(r+=this.writeChunk(e,this.buffer));r<e.length&&!this.endOfStream;){let s=yield this.reader.read();if(s.done){this.endOfStream=!0;break}s.value&&(r+=this.writeChunk(e.subarray(r),s.value))}if(r===0&&this.endOfStream)throw new o;return r})}abort(){return this.interrupted=!0,this.reader.cancel()}close(){return n(this,null,function*(){yield this.abort(),this.reader.releaseLock()})}};function g(a){try{let e=a.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new c(e):new d(e)}catch(e){if(e instanceof TypeError)return new c(a.getReader());throw e}}var f=class{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e?.onClose,e?.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}readToken(r){return n(this,arguments,function*(e,t=this.position){let s=new Uint8Array(e.len);if((yield this.readBuffer(s,{position:t}))<e.len)throw new o;return e.get(s,0)})}peekToken(r){return n(this,arguments,function*(e,t=this.position){let s=new Uint8Array(e.len);if((yield this.peekBuffer(s,{position:t}))<e.len)throw new o;return e.get(s,0)})}readNumber(e){return n(this,null,function*(){if((yield this.readBuffer(this.numBuffer,{length:e.len}))<e.len)throw new o;return e.get(this.numBuffer,0)})}peekNumber(e){return n(this,null,function*(){if((yield this.peekBuffer(this.numBuffer,{length:e.len}))<e.len)throw new o;return e.get(this.numBuffer,0)})}ignore(e){return n(this,null,function*(){if(this.fileInfo.size!==void 0){let t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e})}close(){return n(this,null,function*(){yield this.abort(),yield this.onClose?.()})}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return p({mayBeLess:!1,offset:0,length:e.length,position:this.position},t)}abort(){return Promise.resolve()}};var k=256e3,y=class extends f{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=t?.fileInfo??{}}readBuffer(e,t){return n(this,null,function*(){let r=this.normalizeOptions(e,t),s=r.position-this.position;if(s>0)return yield this.ignore(s),this.readBuffer(e,t);if(s<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(r.length===0)return 0;let i=yield this.streamReader.read(e.subarray(0,r.length),r.mayBeLess);if(this.position+=i,(!t||!t.mayBeLess)&&i<r.length)throw new o;return i})}peekBuffer(e,t){return n(this,null,function*(){let r=this.normalizeOptions(e,t),s=0;if(r.position){let i=r.position-this.position;if(i>0){let m=new Uint8Array(r.length+i);return s=yield this.peekBuffer(m,{mayBeLess:r.mayBeLess}),e.set(m.subarray(i)),s-i}if(i<0)throw new Error("Cannot peek from a negative offset in a stream")}if(r.length>0){try{s=yield this.streamReader.peek(e.subarray(0,r.length),r.mayBeLess)}catch(i){if(t?.mayBeLess&&i instanceof o)return 0;throw i}if(!r.mayBeLess&&s<r.length)throw new o}return s})}ignore(e){return n(this,null,function*(){let t=Math.min(k,e),r=new Uint8Array(t),s=0;for(;s<e;){let i=e-s,m=yield this.readBuffer(r,{length:Math.min(t,i)});if(m<0)return m;s+=m}return s})}abort(){return this.streamReader.abort()}close(){return n(this,null,function*(){return this.streamReader.close()})}supportsRandomAccess(){return!1}};var b=class extends f{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo=S(p({},t?.fileInfo??{}),{size:e.length})}readBuffer(e,t){return n(this,null,function*(){t?.position&&(this.position=t.position);let r=yield this.peekBuffer(e,t);return this.position+=r,r})}peekBuffer(e,t){return n(this,null,function*(){let r=this.normalizeOptions(e,t),s=Math.min(this.uint8Array.length-r.position,r.length);if(!r.mayBeLess&&s<r.length)throw new o;return e.set(this.uint8Array.subarray(r.position,r.position+s)),s})}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}};function we(a,e){let t=g(a),r=e??{},s=r.onClose;return r.onClose=()=>n(this,null,function*(){if(yield t.close(),s)return s()}),new y(t,r)}function ye(a,e){return new b(a,e)}import{open as E}from"fs/promises";var u=class a extends f{static fromFile(e){return n(this,null,function*(){let t=yield E(e,"r"),r=yield t.stat();return new a(t,{fileInfo:{path:e,size:r.size}})})}constructor(e,t){super(t),this.fileHandle=e,this.fileInfo=t.fileInfo}readBuffer(e,t){return n(this,null,function*(){let r=this.normalizeOptions(e,t);if(this.position=r.position,r.length===0)return 0;let s=yield this.fileHandle.read(e,0,r.length,r.position);if(this.position+=s.bytesRead,s.bytesRead<r.length&&(!t||!t.mayBeLess))throw new o;return s.bytesRead})}peekBuffer(e,t){return n(this,null,function*(){let r=this.normalizeOptions(e,t),s=yield this.fileHandle.read(e,0,r.length,r.position);if(!r.mayBeLess&&s.bytesRead<r.length)throw new o;return s.bytesRead})}close(){return n(this,null,function*(){return yield this.fileHandle.close(),B(a.prototype,this,"close").call(this)})}setPosition(e){this.position=e}supportsRandomAccess(){return!0}};var Ce=u.fromFile;export{o as a,we as b,ye as c};
