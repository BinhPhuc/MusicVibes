import"./chunk-KZAVUP2Y.js";import{b as X}from"./chunk-XH55ZYNT.js";import{a as K}from"./chunk-NESCWZJB.js";import"./chunk-P4BZCRG7.js";import{a as f}from"./chunk-OEW7T7QN.js";import"./chunk-K776FSIA.js";import"./chunk-VYVOHQNH.js";import{a as Q,c as J}from"./chunk-7GI4CMUR.js";import{A as w,B as H,C as V,H as Y,I as Z,e as M,f as c,h,j as T,l as u,n as i,o as R,p as I,q as W,r as p,v as b,z as B}from"./chunk-DNMECVE7.js";var he=M(V(),1);var ce=M(V(),1);var te=M(V(),1);var ne=(0,te.default)("music-metadata:parser:MP4:atom"),k=class extends Y("MP4"){},E={len:8,get:(s,e)=>{let t=i.get(s,e);if(t<0)throw new k("Invalid atom header length");return{length:BigInt(t),name:new w(4,"latin1").get(s,e+4)}},put:(s,e,t)=>(i.put(s,e,Number(t.length)),f.put(s,e+4,t.name))},ae=b,G={len:4,get:(s,e)=>({type:new w(4,"ascii").get(s,e)})};var _=class{constructor(e,t,n){if(this.len=e,e<t)throw new k(`Atom ${n} expected to be ${t}, but specifies ${e} bytes long.`);e>t&&ne(`Warning: atom ${n} expected to be ${t}, but was actually ${e} bytes long.`)}},N={len:4,get:(s,e)=>{let t=i.get(s,e)-2082844800;return new Date(t*1e3)}},U=class extends _{constructor(e){super(e,24,"mdhd"),this.len=e}get(e,t){return{version:h.get(e,t+0),flags:u.get(e,t+1),creationTime:N.get(e,t+4),modificationTime:N.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),language:T.get(e,t+20),quality:T.get(e,t+22)}}},A=class extends _{constructor(e){super(e,100,"mvhd"),this.len=e}get(e,t){return{version:h.get(e,t),flags:u.get(e,t+1),creationTime:N.get(e,t+4),modificationTime:N.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),preferredRate:i.get(e,t+20),preferredVolume:T.get(e,t+24),previewTime:i.get(e,t+72),previewDuration:i.get(e,t+76),posterTime:i.get(e,t+80),selectionTime:i.get(e,t+84),selectionDuration:i.get(e,t+88),currentTime:i.get(e,t+92),nextTrackID:i.get(e,t+96)}}},x=class{constructor(e){this.len=e}get(e,t){return{type:{set:h.get(e,t+0),type:u.get(e,t+1)},locale:u.get(e,t+4),value:new B(this.len-8).get(e,t+8)}}},z=class{constructor(e){this.len=e}get(e,t){return{version:h.get(e,t),flags:u.get(e,t+1),name:new w(this.len-4,"utf-8").get(e,t+4)}}},C=class{constructor(e){this.len=e}get(e,t){return{version:h.get(e,t),flags:u.get(e,t+1),creationTime:N.get(e,t+4),modificationTime:N.get(e,t+8),trackId:i.get(e,t+12),duration:i.get(e,t+20),layer:T.get(e,t+24),alternateGroup:T.get(e,t+26),volume:T.get(e,t+28)}}},ee={len:8,get:(s,e)=>({version:h.get(s,e),flags:u.get(s,e+1),numberOfEntries:i.get(s,e+4)})},j=class{constructor(e){this.len=e}get(e,t){let n=this.len-12;return{dataFormat:f.get(e,t),dataReferenceIndex:T.get(e,t+10),description:n>0?new B(n).get(e,t+12):void 0}}},$=class{constructor(e){this.len=e}get(e,t){let n=ee.get(e,t);t+=ee.len;let a=[];for(let o=0;o<n.numberOfEntries;++o){let r=i.get(e,t);t+=i.len,a.push(new j(r-i.len).get(e,t)),t+=r}return{header:n,table:a}}},q={len:8,get(s,e){return{version:I.get(s,e),revision:I.get(s,e+2),vendor:p.get(s,e+4)}}},se={len:12,get(s,e){return{numAudioChannels:I.get(s,e+0),sampleSize:I.get(s,e+2),compressionId:I.get(s,e+4),packetSize:I.get(s,e+6),sampleRate:T.get(s,e+8)+T.get(s,e+10)/1e4}}},S=class{constructor(e,t){this.len=e,this.token=t}get(e,t){let n=p.get(e,t+4);return{version:R.get(e,t+0),flags:W.get(e,t+1),numberOfEntries:n,entries:oe(e,this.token,t+8,this.len-8,n)}}},Te={len:8,get(s,e){return{count:p.get(s,e+0),duration:p.get(s,e+4)}}},v=class extends S{constructor(e){super(e,Te),this.len=e}},pe={len:12,get(s,e){return{firstChunk:p.get(s,e),samplesPerChunk:p.get(s,e+4),sampleDescriptionId:p.get(s,e+8)}}},D=class extends S{constructor(e){super(e,pe),this.len=e}},P=class{constructor(e){this.len=e}get(e,t){let n=p.get(e,t+8);return{version:R.get(e,t),flags:W.get(e,t+1),sampleSize:p.get(e,t+4),numberOfEntries:n,entries:oe(e,p,t+12,this.len-12,n)}}},F=class extends S{constructor(e){super(e,p),this.len=e}},O=class{constructor(e){this.len=e}get(e,t){let n=I.get(e,t+0);return new w(n,"utf-8").get(e,t+2)}};function oe(s,e,t,n,a){if(ne(`remainingLen=${n}, numberOfEntries=${a} * token-len=${e.len}`),n===0)return[];if(n!==a*e.len)throw new k("mismatch number-of-entries with remaining atom-length");let o=[];for(let r=0;r<a;++r)o.push(e.get(s,t)),t+=e.len;return o}var ie=(0,ce.default)("music-metadata:parser:MP4:Atom"),L=class s{static readAtom(e,t,n,a){return c(this,null,function*(){let o=e.position;ie(`Reading next token on offset=${o}...`);let r=yield e.readToken(E),d=r.length===1n;d&&(r.length=yield e.readToken(ae));let m=new s(r,d,n),l=m.getPayloadLength(a);return ie(`parse atom name=${m.atomPath}, extended=${m.extended}, offset=${o}, len=${m.header.length}`),yield m.readData(e,t,l),m})}constructor(e,t,n){this.header=e,this.extended=t,this.parent=n,this.children=[],this.atomPath=(this.parent?`${this.parent.atomPath}.`:"")+this.header.name}getHeaderLength(){return this.extended?16:8}getPayloadLength(e){return(this.header.length===0n?e:Number(this.header.length))-this.getHeaderLength()}readAtoms(e,t,n){return c(this,null,function*(){for(;n>0;){let a=yield s.readAtom(e,t,this,n);this.children.push(a),n-=a.header.length===0n?n:Number(a.header.length)}})}readData(e,t,n){return c(this,null,function*(){switch(this.header.name){case"moov":case"udta":case"trak":case"mdia":case"minf":case"stbl":case"<id>":case"ilst":case"tref":return this.readAtoms(e,t,this.getPayloadLength(n));case"meta":{let o=(yield e.peekToken(E)).name==="hdlr"?0:4;return yield e.ignore(o),this.readAtoms(e,t,this.getPayloadLength(n)-o)}default:return t(this,n)}})}};var g=(0,he.default)("music-metadata:parser:MP4"),ge="iTunes",de={raw:{lossy:!1,format:"raw"},MAC3:{lossy:!0,format:"MACE 3:1"},MAC6:{lossy:!0,format:"MACE 6:1"},ima4:{lossy:!0,format:"IMA 4:1"},ulaw:{lossy:!0,format:"uLaw 2:1"},alaw:{lossy:!0,format:"uLaw 2:1"},Qclp:{lossy:!0,format:"QUALCOMM PureVoice"},".mp3":{lossy:!0,format:"MPEG-1 layer 3"},alac:{lossy:!1,format:"ALAC"},"ac-3":{lossy:!0,format:"AC-3"},mp4a:{lossy:!0,format:"MPEG-4/AAC"},mp4s:{lossy:!0,format:"MP4S"},c608:{lossy:!0,format:"CEA-608"},c708:{lossy:!0,format:"CEA-708"}};function me(s,e,t){return t.indexOf(s)===e}var le=class s extends Z{constructor(){super(...arguments),this.tracks=[],this.atomParsers={mvhd:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new A(e));this.metadata.setFormat("creationTime",t.creationTime),this.metadata.setFormat("modificationTime",t.modificationTime)}),mdhd:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new U(e)),n=this.getTrackDescription();n.creationTime=t.creationTime,n.modificationTime=t.modificationTime,n.timeScale=t.timeScale,n.duration=t.duration}),chap:e=>c(this,null,function*(){let t=this.getTrackDescription(),n=[];for(;e>=i.len;)n.push(yield this.tokenizer.readNumber(i)),e-=i.len;t.chapterList=n}),tkhd:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new C(e));this.tracks.push(t)}),mdat:e=>c(this,null,function*(){if(this.audioLengthInBytes=e,this.calculateBitRate(),this.options.includeChapters){let t=this.tracks.filter(n=>n.chapterList);if(t.length===1){let n=t[0].chapterList,a=this.tracks.filter(o=>n.indexOf(o.trackId)!==-1);if(a.length===1)return this.parseChapterTrack(a[0],t[0],e)}}yield this.tokenizer.ignore(e)}),ftyp:e=>c(this,null,function*(){let t=[];for(;e>0;){let a=yield this.tokenizer.readToken(G);e-=G.len;let o=a.type.replace(/\W/g,"");o.length>0&&t.push(o)}g(`ftyp: ${t.join("/")}`);let n=t.filter(me).join("/");this.metadata.setFormat("container",n)}),stsd:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new $(e)),n=this.getTrackDescription();n.soundSampleDescription=t.table.map(a=>this.parseSoundSampleDescription(a))}),stsc:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new D(e));this.getTrackDescription().sampleToChunkTable=t.entries}),stts:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new v(e));this.getTrackDescription().timeToSampleTable=t.entries}),stsz:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new P(e)),n=this.getTrackDescription();n.sampleSize=t.sampleSize,n.sampleSizeTable=t.entries}),stco:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new F(e));this.getTrackDescription().chunkOffsetTable=t.entries}),date:e=>c(this,null,function*(){let t=yield this.tokenizer.readToken(new w(e,"utf-8"));yield this.addTag("date",t)})}}static read_BE_Integer(e,t){let n=(t?"INT":"UINT")+e.length*8+(e.length>1?"_BE":""),a=H[n];if(!a)throw new k(`Token for integer type not found: "${n}"`);return Number(a.get(e,0))}parse(){return c(this,null,function*(){this.tracks=[];let e=this.tokenizer.fileInfo.size||0;for(;!this.tokenizer.fileInfo.size||e>0;){try{if((yield this.tokenizer.peekToken(E)).name==="\0\0\0\0"){let r=`Error at offset=${this.tokenizer.position}: box.id=0`;g(r),this.addWarning(r);break}}catch(o){if(o instanceof Error){let r=`Error at offset=${this.tokenizer.position}: ${o.message}`;g(r),this.addWarning(r)}else throw o;break}let a=yield L.readAtom(this.tokenizer,(o,r)=>this.handleAtom(o,r),null,e);e-=a.header.length===BigInt(0)?e:Number(a.header.length)}let t=[];this.tracks.forEach(a=>{let o=[];a.soundSampleDescription.forEach(r=>{let d={},m=de[r.dataFormat];if(m?(o.push(m.format),d.codecName=m.format):d.codecName=`<${r.dataFormat}>`,r.description){let{description:l}=r;l.sampleRate>0&&(d.type=X.audio,d.audio={samplingFrequency:l.sampleRate,bitDepth:l.sampleSize,channels:l.numAudioChannels})}this.metadata.addStreamInfo(d)}),o.length>=1&&t.push(o.join("/"))}),t.length>0&&this.metadata.setFormat("codec",t.filter(me).join("+"));let n=this.tracks.filter(a=>a.soundSampleDescription.length>=1&&a.soundSampleDescription[0].description&&a.soundSampleDescription[0].description.numAudioChannels>0);if(n.length>=1){let a=n[0];if(a.timeScale>0){let d=a.duration/a.timeScale;this.metadata.setFormat("duration",d)}let o=a.soundSampleDescription[0];if(o.description&&(this.metadata.setFormat("sampleRate",o.description.sampleRate),this.metadata.setFormat("bitsPerSample",o.description.sampleSize),this.metadata.setFormat("numberOfChannels",o.description.numAudioChannels),a.timeScale===0&&a.timeToSampleTable.length>0)){let m=a.timeToSampleTable.map(l=>l.count*l.duration).reduce((l,y)=>l+y)/o.description.sampleRate;this.metadata.setFormat("duration",m)}let r=de[o.dataFormat];r&&this.metadata.setFormat("lossless",!r.lossy),this.calculateBitRate()}})}handleAtom(e,t){return c(this,null,function*(){if(e.parent)switch(e.parent.header.name){case"ilst":case"<id>":return this.parseMetadataItemData(e)}if(this.atomParsers[e.header.name])return this.atomParsers[e.header.name](t);g(`No parser for atom path=${e.atomPath}, payload-len=${t}, ignoring atom`),yield this.tokenizer.ignore(t)})}getTrackDescription(){return this.tracks[this.tracks.length-1]}calculateBitRate(){this.audioLengthInBytes&&this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLengthInBytes/this.metadata.format.duration)}addTag(e,t){return c(this,null,function*(){yield this.metadata.addTag(ge,e,t)})}addWarning(e){g(`Warning: ${e}`),this.metadata.addWarning(e)}parseMetadataItemData(e){let t=e.header.name;return e.readAtoms(this.tokenizer,(n,a)=>c(this,null,function*(){let o=n.getPayloadLength(a);switch(n.header.name){case"data":return this.parseValueAtom(t,n);case"name":case"mean":case"rate":{let r=yield this.tokenizer.readToken(new z(o));t+=`:${r.name}`;break}default:{let r=yield this.tokenizer.readToken(new B(o));this.addWarning(`Unsupported meta-item: ${t}[${n.header.name}] => value=${J(r)} ascii=${Q(r,"ascii")}`)}}}),e.getPayloadLength(0))}parseValueAtom(e,t){return c(this,null,function*(){let n=yield this.tokenizer.readToken(new x(Number(t.header.length)-E.len));if(n.type.set!==0)throw new k(`Unsupported type-set != 0: ${n.type.set}`);switch(n.type.type){case 0:switch(e){case"trkn":case"disk":{let a=h.get(n.value,3),o=h.get(n.value,5);yield this.addTag(e,`${a}/${o}`);break}case"gnre":{let a=h.get(n.value,1),o=K[a-1];yield this.addTag(e,o);break}case"rate":{let a=new TextDecoder("ascii").decode(n.value);yield this.addTag(e,a);break}default:g(`unknown proprietary value type for: ${t.atomPath}`)}break;case 1:case 18:yield this.addTag(e,new TextDecoder("utf-8").decode(n.value));break;case 13:if(this.options.skipCovers)break;yield this.addTag(e,{format:"image/jpeg",data:Uint8Array.from(n.value)});break;case 14:if(this.options.skipCovers)break;yield this.addTag(e,{format:"image/png",data:Uint8Array.from(n.value)});break;case 21:yield this.addTag(e,s.read_BE_Integer(n.value,!0));break;case 22:yield this.addTag(e,s.read_BE_Integer(n.value,!1));break;case 65:yield this.addTag(e,h.get(n.value,0));break;case 66:yield this.addTag(e,T.get(n.value,0));break;case 67:yield this.addTag(e,i.get(n.value,0));break;default:this.addWarning(`atom key=${e}, has unknown well-known-type (data-type): ${n.type.type}`)}})}parseSoundSampleDescription(e){let t={dataFormat:e.dataFormat,dataReferenceIndex:e.dataReferenceIndex},n=0;if(e.description){let a=q.get(e.description,n);n+=q.len,a.version===0||a.version===1?t.description=se.get(e.description,n):g(`Warning: sound-sample-description ${a} not implemented`)}return t}parseChapterTrack(e,t,n){return c(this,null,function*(){if(!e.sampleSize&&e.chunkOffsetTable.length!==e.sampleSizeTable.length)throw new Error("Expected equal chunk-offset-table & sample-size-table length.");let a=[];for(let o=0;o<e.chunkOffsetTable.length&&n>0;++o){let d=e.chunkOffsetTable[o]-this.tokenizer.position,m=e.sampleSize>0?e.sampleSize:e.sampleSizeTable[o];if(n-=d+m,n<0)throw new k("Chapter chunk exceeding token length");yield this.tokenizer.ignore(d);let l=yield this.tokenizer.readToken(new O(m));g(`Chapter ${o+1}: ${l}`);let y={title:l,sampleOffset:this.findSampleOffset(t,this.tokenizer.position)};g(`Chapter title=${y.title}, offset=${y.sampleOffset}/${this.tracks[0].duration}`),a.push(y)}this.metadata.setFormat("chapters",a),yield this.tokenizer.ignore(n)})}findSampleOffset(e,t){let n=0;e.timeToSampleTable.forEach(o=>{n+=o.count*o.duration}),g(`Total duration=${n}`);let a=0;for(;a<e.chunkOffsetTable.length&&e.chunkOffsetTable[a]<t;)++a;return this.getChunkDuration(a+1,e)}getChunkDuration(e,t){let n=0,a=t.timeToSampleTable[n].count,o=t.timeToSampleTable[n].duration,r=1,d=this.getSamplesPerChunk(r,t.sampleToChunkTable),m=0;for(;r<e;){let l=Math.min(a,d);m+=l*o,a-=l,d-=l,d===0?(++r,d=this.getSamplesPerChunk(r,t.sampleToChunkTable)):(++n,a=t.timeToSampleTable[n].count,o=t.timeToSampleTable[n].duration)}return m}getSamplesPerChunk(e,t){for(let n=0;n<t.length-1;++n)if(e>=t[n].firstChunk&&e<t[n+1].firstChunk)return t[n].samplesPerChunk;return t[t.length-1].samplesPerChunk}};export{le as MP4Parser};
