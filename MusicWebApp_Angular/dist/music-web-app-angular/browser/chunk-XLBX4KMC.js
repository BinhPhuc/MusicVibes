import{a as C}from"./chunk-472C3MNF.js";import"./chunk-6JDSCIYQ.js";import"./chunk-NESCWZJB.js";import"./chunk-P4BZCRG7.js";import"./chunk-OEW7T7QN.js";import{a as f}from"./chunk-K776FSIA.js";import"./chunk-VYVOHQNH.js";import{l as _,m as n,n as m}from"./chunk-7GI4CMUR.js";import{A as d,C as N,H as x,e as D,f as r,h as p,j as w,n as h,p as I,z as S}from"./chunk-DNMECVE7.js";var L=D(N(),1);var b={len:2,get:(i,e)=>{let t=n(i,e,0,3),a=n(i,e,6,1),s=n(i,e,7,9)/10;if(t>0)return{type:n(i,e,0,3),origin:n(i,e,3,3),adjustment:a?-s:s}}};var B={len:27,get:(i,e)=>{let t=h.get(i,e+2);return{revision:n(i,e,0,4),vbr_method:n(i,e,4,4),lowpass_filter:100*p.get(i,e+1),track_peak:t===0?null:t/2**23,track_gain:b.get(i,6),album_gain:b.get(i,8),music_length:h.get(i,e+20),music_crc:p.get(i,e+24),header_crc:w.get(i,e+24)}}};var F=new d(4,"ascii"),g=new d(6,"ascii"),R={len:4,get:(i,e)=>({frames:m(i,e,31),bytes:m(i,e,30),toc:m(i,e,29),vbrScale:m(i,e,28)})};function A(i){return r(this,null,function*(){let e=yield i.readToken(R),t={numFrames:null,streamSize:null,vbrScale:null};if(e.frames&&(t.numFrames=yield i.readToken(h)),e.bytes&&(t.streamSize=yield i.readToken(h)),e.toc&&(t.toc=new Uint8Array(100),yield i.readBuffer(t.toc)),e.vbrScale&&(t.vbrScale=yield i.readToken(h)),(yield i.peekToken(new d(4,"ascii")))==="LAME"){yield i.ignore(4),t.lame={version:yield i.readToken(new d(5,"ascii"))};let s=t.lame.version.match(/\d+.\d+/g);if(s!==null){let u=s[0].split(".").map(M=>Number.parseInt(M,10));u[0]>=3&&u[1]>=90&&(t.lame.extended=yield i.readToken(B))}}return t})}var o=(0,L.default)("music-metadata:parser:mpeg"),c=class extends x("MPEG"){},P=1024,v={AudioObjectTypes:["AAC Main","AAC LC","AAC SSR","AAC LTP"],SamplingFrequencies:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,null,null,-1]},H=[void 0,["front-center"],["front-left","front-right"],["front-center","front-left","front-right"],["front-center","front-left","front-right","back-center"],["front-center","front-left","front-right","back-left","back-right"],["front-center","front-left","front-right","back-left","back-right","LFE-channel"],["front-center","front-left","front-right","side-left","side-right","back-left","back-right","LFE-channel"]],y=(()=>{class i{constructor(t,a){this.bitrateIndex=null,this.sampRateFreqIndex=null,this.padding=null,this.privateBit=null,this.channelModeIndex=null,this.modeExtension=null,this.isOriginalMedia=null,this.version=null,this.bitrate=null,this.samplingRate=null,this.frameLength=0,this.versionIndex=n(t,a+1,3,2),this.layer=i.LayerDescription[n(t,a+1,5,2)],this.versionIndex>1&&this.layer===0?this.parseAdtsHeader(t,a):this.parseMpegHeader(t,a),this.isProtectedByCRC=!m(t,a+1,7)}calcDuration(t){return this.samplingRate==null?null:t*this.calcSamplesPerFrame()/this.samplingRate}calcSamplesPerFrame(){return i.samplesInFrameTable[this.version===1?0:1][this.layer]}calculateSideInfoLength(){if(this.layer!==3)return 2;if(this.channelModeIndex===3){if(this.version===1)return 17;if(this.version===2||this.version===2.5)return 9}else{if(this.version===1)return 32;if(this.version===2||this.version===2.5)return 17}return null}calcSlotSize(){return[null,4,1,1][this.layer]}parseMpegHeader(t,a){this.container="MPEG",this.bitrateIndex=n(t,a+2,0,4),this.sampRateFreqIndex=n(t,a+2,4,2),this.padding=m(t,a+2,6),this.privateBit=m(t,a+2,7),this.channelModeIndex=n(t,a+3,0,2),this.modeExtension=n(t,a+3,2,2),this.isCopyrighted=m(t,a+3,4),this.isOriginalMedia=m(t,a+3,5),this.emphasis=n(t,a+3,7,2),this.version=i.VersionID[this.versionIndex],this.channelMode=i.ChannelMode[this.channelModeIndex],this.codec=`MPEG ${this.version} Layer ${this.layer}`;let s=this.calcBitrate();if(!s)throw new c("Cannot determine bit-rate");if(this.bitrate=s*1e3,this.samplingRate=this.calcSamplingRate(),this.samplingRate==null)throw new c("Cannot determine sampling-rate")}parseAdtsHeader(t,a){o("layer=0 => ADTS"),this.version=this.versionIndex===2?4:2,this.container=`ADTS/MPEG-${this.version}`;let s=n(t,a+2,0,2);this.codec="AAC",this.codecProfile=v.AudioObjectTypes[s],o(`MPEG-4 audio-codec=${this.codec}`);let l=n(t,a+2,2,4);this.samplingRate=v.SamplingFrequencies[l],o(`sampling-rate=${this.samplingRate}`);let u=n(t,a+2,7,3);this.mp4ChannelConfig=H[u],o(`channel-config=${this.mp4ChannelConfig?this.mp4ChannelConfig.join("+"):"?"}`),this.frameLength=n(t,a+3,6,2)<<11}calcBitrate(){if(this.bitrateIndex===0||this.bitrateIndex===15)return null;if(this.version&&this.bitrateIndex){let t=10*Math.floor(this.version)+this.layer;return i.bitrate_index[this.bitrateIndex][t]}return null}calcSamplingRate(){return this.sampRateFreqIndex===3||this.version===null||this.sampRateFreqIndex==null?null:i.sampling_rate_freq_index[this.version][this.sampRateFreqIndex]}}return i.SyncByte1=255,i.SyncByte2=224,i.VersionID=[2.5,null,2,1],i.LayerDescription=[0,3,2,1],i.ChannelMode=["stereo","joint_stereo","dual_channel","mono"],i.bitrate_index={1:{11:32,12:32,13:32,21:32,22:8,23:8},2:{11:64,12:48,13:40,21:48,22:16,23:16},3:{11:96,12:56,13:48,21:56,22:24,23:24},4:{11:128,12:64,13:56,21:64,22:32,23:32},5:{11:160,12:80,13:64,21:80,22:40,23:40},6:{11:192,12:96,13:80,21:96,22:48,23:48},7:{11:224,12:112,13:96,21:112,22:56,23:56},8:{11:256,12:128,13:112,21:128,22:64,23:64},9:{11:288,12:160,13:128,21:144,22:80,23:80},10:{11:320,12:192,13:160,21:160,22:96,23:96},11:{11:352,12:224,13:192,21:176,22:112,23:112},12:{11:384,12:256,13:224,21:192,22:128,23:128},13:{11:416,12:320,13:256,21:224,22:144,23:144},14:{11:448,12:384,13:320,21:256,22:160,23:160}},i.sampling_rate_freq_index={1:{0:44100,1:48e3,2:32e3},2:{0:22050,1:24e3,2:16e3},2.5:{0:11025,1:12e3,2:8e3}},i.samplesInFrameTable=[[0,384,1152,1152],[0,384,1152,576]],i})(),z={len:4,get:(i,e)=>new y(i,e)};function $(i){return`V${Math.floor((100-i)/10)}`}var E=class extends C{constructor(){super(...arguments),this.frameCount=0,this.syncFrameCount=-1,this.countSkipFrameData=0,this.totalDataLength=0,this.bitrates=[],this.offset=0,this.frame_size=0,this.crc=null,this.calculateEofDuration=!1,this.samplesPerFrame=null,this.buf_frame_header=new Uint8Array(4),this.mpegOffset=null,this.syncPeek={buf:new Uint8Array(P),len:0}}postId3v2Parse(){return r(this,null,function*(){this.metadata.setFormat("lossless",!1);try{let e=!1;for(;!e;)yield this.sync(),e=yield this.parseCommonMpegHeader()}catch(e){if(e instanceof f){if(o("End-of-stream"),this.calculateEofDuration&&this.samplesPerFrame!==null){let t=this.frameCount*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",t),this.metadata.format.sampleRate){let a=t/this.metadata.format.sampleRate;o(`Calculate duration at EOF: ${a} sec.`,a),this.metadata.setFormat("duration",a)}}}else throw e}})}finalize(){let e=this.metadata.format,t=!!this.metadata.native.ID3v1;if(this.mpegOffset!==null){if(e.duration&&this.tokenizer.fileInfo.size){let a=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);e.codecProfile&&e.codecProfile[0]==="V"&&this.metadata.setFormat("bitrate",a*8/e.duration)}if(this.tokenizer.fileInfo.size&&e.codecProfile==="CBR"){let a=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);if(this.frame_size!==null&&this.samplesPerFrame!==null){let s=Math.round(a/this.frame_size)*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",s),e.sampleRate&&!e.duration){let l=s/e.sampleRate;o("Calculate CBR duration based on file size: %s",l),this.metadata.setFormat("duration",l)}}}}}sync(){return r(this,null,function*(){let e=!1;for(;;){let t=0;if(this.syncPeek.len=yield this.tokenizer.peekBuffer(this.syncPeek.buf,{length:P,mayBeLess:!0}),this.syncPeek.len<=163)throw new f;for(;;){if(e&&(this.syncPeek.buf[t]&224)===224){this.buf_frame_header[0]=y.SyncByte1,this.buf_frame_header[1]=this.syncPeek.buf[t],yield this.tokenizer.ignore(t),o(`Sync at offset=${this.tokenizer.position-1}, frameCount=${this.frameCount}`),this.syncFrameCount===this.frameCount&&(o(`Re-synced MPEG stream, frameCount=${this.frameCount}`),this.frameCount=0,this.frame_size=0),this.syncFrameCount=this.frameCount;return}if(e=!1,t=this.syncPeek.buf.indexOf(y.SyncByte1,t),t===-1){if(this.syncPeek.len<this.syncPeek.buf.length)throw new f;yield this.tokenizer.ignore(this.syncPeek.len);break}++t,e=!0}}})}parseCommonMpegHeader(){return r(this,null,function*(){this.frameCount===0&&(this.mpegOffset=this.tokenizer.position-1),yield this.tokenizer.peekBuffer(this.buf_frame_header.subarray(1),{length:3});let e;try{e=z.get(this.buf_frame_header,0)}catch(t){if(yield this.tokenizer.ignore(1),t instanceof Error)return this.metadata.addWarning(`Parse error: ${t.message}`),!1;throw t}return yield this.tokenizer.ignore(3),this.metadata.setFormat("container",e.container),this.metadata.setFormat("codec",e.codec),this.metadata.setFormat("lossless",!1),this.metadata.setFormat("sampleRate",e.samplingRate),this.frameCount++,e.version!==null&&e.version>=2&&e.layer===0?this.parseAdts(e):this.parseAudioFrameHeader(e)})}parseAudioFrameHeader(e){return r(this,null,function*(){this.metadata.setFormat("numberOfChannels",e.channelMode==="mono"?1:2),this.metadata.setFormat("bitrate",e.bitrate),this.frameCount<20*1e4&&o("offset=%s MP%s bitrate=%s sample-rate=%s",this.tokenizer.position-4,e.layer,e.bitrate,e.samplingRate);let t=e.calcSlotSize();if(t===null)throw new c("invalid slot_size");let a=e.calcSamplesPerFrame();o(`samples_per_frame=${a}`);let s=a/8;if(e.bitrate!==null&&e.samplingRate!=null){let l=s*e.bitrate/e.samplingRate+(e.padding?t:0);this.frame_size=Math.floor(l)}if(this.audioFrameHeader=e,e.bitrate!==null&&this.bitrates.push(e.bitrate),this.frameCount===1)return this.offset=z.len,yield this.skipSideInformation(),!1;if(this.frameCount===3){if(this.areAllSame(this.bitrates)){if(this.samplesPerFrame=a,this.metadata.setFormat("codecProfile","CBR"),this.tokenizer.fileInfo.size)return!0}else if(this.metadata.format.duration)return!0;if(!this.options.duration)return!0}return this.options.duration&&this.frameCount===4&&(this.samplesPerFrame=a,this.calculateEofDuration=!0),this.offset=4,e.isProtectedByCRC?(yield this.parseCrc(),!1):(yield this.skipSideInformation(),!1)})}parseAdts(e){return r(this,null,function*(){let t=new Uint8Array(3);if(yield this.tokenizer.readBuffer(t),e.frameLength+=n(t,0,0,11),this.totalDataLength+=e.frameLength,this.samplesPerFrame=1024,e.samplingRate!==null){let a=e.samplingRate/this.samplesPerFrame,l=8*(this.frameCount===0?0:this.totalDataLength/this.frameCount)*a+.5;this.metadata.setFormat("bitrate",l),o(`frame-count=${this.frameCount}, size=${e.frameLength} bytes, bit-rate=${l}`)}if(yield this.tokenizer.ignore(e.frameLength>7?e.frameLength-7:1),this.frameCount===3)if(this.metadata.setFormat("codecProfile",e.codecProfile),e.mp4ChannelConfig&&this.metadata.setFormat("numberOfChannels",e.mp4ChannelConfig.length),this.options.duration)this.calculateEofDuration=!0;else return!0;return!1})}parseCrc(){return r(this,null,function*(){return this.crc=yield this.tokenizer.readNumber(I),this.offset+=2,this.skipSideInformation()})}skipSideInformation(){return r(this,null,function*(){if(this.audioFrameHeader){let e=this.audioFrameHeader.calculateSideInfoLength();if(e!==null){yield this.tokenizer.readToken(new S(e)),this.offset+=e,yield this.readXtraInfoHeader();return}}})}readXtraInfoHeader(){return r(this,null,function*(){let e=yield this.tokenizer.readToken(F);switch(this.offset+=F.len,e){case"Info":return this.metadata.setFormat("codecProfile","CBR"),this.readXingInfoHeader();case"Xing":{let a=yield this.readXingInfoHeader();if(a.vbrScale!==null){let s=$(a.vbrScale);this.metadata.setFormat("codecProfile",s)}return null}case"Xtra":break;case"LAME":{let a=yield this.tokenizer.readToken(g);if(this.frame_size!==null&&this.frame_size>=this.offset+g.len)return this.offset+=g.len,this.metadata.setFormat("tool",`LAME ${a}`),yield this.skipFrameData(this.frame_size-this.offset),null;this.metadata.addWarning("Corrupt LAME header");break}}let t=this.frame_size-this.offset;return t<0?this.metadata.addWarning(`Frame ${this.frameCount}corrupt: negative frameDataLeft`):yield this.skipFrameData(t),null})}readXingInfoHeader(){return r(this,null,function*(){let e=this.tokenizer.position,t=yield A(this.tokenizer);if(this.offset+=this.tokenizer.position-e,t.lame&&(this.metadata.setFormat("tool",`LAME ${_(t.lame.version)}`),t.lame.extended&&(this.metadata.setFormat("trackPeakLevel",t.lame.extended.track_peak),t.lame.extended.track_gain&&this.metadata.setFormat("trackGain",t.lame.extended.track_gain.adjustment),t.lame.extended.album_gain&&this.metadata.setFormat("albumGain",t.lame.extended.album_gain.adjustment),this.metadata.setFormat("duration",t.lame.extended.music_length/1e3))),t.streamSize&&this.audioFrameHeader&&t.numFrames!==null){let s=this.audioFrameHeader.calcDuration(t.numFrames);return this.metadata.setFormat("duration",s),o("Get duration from Xing header: %s",this.metadata.format.duration),t}let a=this.frame_size-this.offset;return yield this.skipFrameData(a),t})}skipFrameData(e){return r(this,null,function*(){if(e<0)throw new c("frame-data-left cannot be negative");yield this.tokenizer.ignore(e),this.countSkipFrameData+=e})}areAllSame(e){let t=e[0];return e.every(a=>a===t)}};export{c as MpegContentError,E as MpegParser};
