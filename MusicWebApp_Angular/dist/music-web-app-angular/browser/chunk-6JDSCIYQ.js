import{a as L}from"./chunk-NESCWZJB.js";import{a as N,d as $,e as B,f as S,g as F,h as D,i as v}from"./chunk-VYVOHQNH.js";import{h as p,i as m,k as h}from"./chunk-7GI4CMUR.js";import{C as R,H as E,e as Z,f as T,h as H,l as P,n as k,z as b}from"./chunk-DNMECVE7.js";var M=Z(R(),1);var U=(0,M.default)("music-metadata:id3v2:frame-parser"),f="latin1";function Y(r){let e=[],t,a="";for(let s of r)if(typeof t=="string")if(s==="("&&t==="")a+="(",t=void 0;else if(s===")"){a!==""&&(e.push(a),a="");let g=W(t);g&&e.push(g),t=void 0}else t+=s;else s==="("?t="":a+=s;return a&&(e.length===0&&a.match(/^\d*$/)&&(a=W(a)),a&&e.push(a)),e}function W(r){if(r==="RX")return"Remix";if(r==="CR")return"Cover";if(r.match(/^\d*$/))return L[Number.parseInt(r)]}var I=class r{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,t,a){if(e.length===0){this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${t}`);return}let{encoding:s,bom:g}=F.get(e,0),d=e.length,i=0,o=[],z=r.getNullTerminatorLength(s),c;switch(U(`Parsing tag type=${t}, encoding=${s}, bom=${g}`),t!=="TXXX"&&t[0]==="T"?"T*":t){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let n;try{n=h(e.slice(1),s).replace(/\x00+$/,"")}catch(l){if(l instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} header has invalid string value: ${l.message}`);break}throw l}switch(t){case"TMCL":case"TIPL":case"IPLS":o=r.functionList(this.splitValue(t,n));break;case"TRK":case"TRCK":case"TPOS":o=n;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":o=this.splitValue(t,n);break;case"TCO":case"TCON":o=this.splitValue(t,n).map(l=>Y(l)).reduce((l,u)=>l.concat(u),[]);break;case"PCS":case"PCST":o=this.major>=4?this.splitValue(t,n):[n],o=Array.isArray(o)&&o[0]===""?1:0;break;default:o=this.major>=4?this.splitValue(t,n):[n]}break}case"TXXX":{let n=r.readIdentifierAndData(e,i+1,d,s);o={description:n.id,text:this.splitValue(t,h(n.data,s).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(a){let n={};switch(i+=1,this.major){case 2:n.format=h(e.slice(i,i+3),"latin1"),i+=3;break;case 3:case 4:c=m(e,i,d,f),n.format=h(e.slice(i,c),f),i=c+1;break;default:throw K(this.major)}n.format=r.fixPictureMimeType(n.format),n.type=N[e[i]],i+=1,c=m(e,i,d,s),n.description=h(e.slice(i,c),s),i=c+z,n.data=e.slice(i,d),o=n}break;case"CNT":case"PCNT":o=k.get(e,0);break;case"SYLT":{let n=v.get(e,0);i+=v.len;let l={descriptor:"",language:n.language,contentType:n.contentType,timeStampFormat:n.timeStampFormat,syncText:[]},u=!1;for(;i<d;){let w=r.readNullTerminatedString(e.subarray(i),n.encoding);if(i+=w.len,u){let X=k.get(e,i);i+=k.len,l.syncText.push({text:w.text,timestamp:X})}else l.descriptor=w.text,u=!0}o=l;break}case"ULT":case"USLT":case"COM":case"COMM":{let n=D.get(e,i);i+=D.len;let l=r.readNullTerminatedString(e.subarray(i),n.encoding);i+=l.len;let u=r.readNullTerminatedString(e.subarray(i),n.encoding);o={language:n.language,descriptor:l.text,text:u.text};break}case"UFID":{let n=r.readIdentifierAndData(e,i,d,f);o={owner_identifier:n.id,identifier:n.data};break}case"PRIV":{let n=r.readIdentifierAndData(e,i,d,f);o={owner_identifier:n.id,data:n.data};break}case"POPM":{c=m(e,i,d,f);let n=h(e.slice(i,c),f);i=c+1;let l=d-i;o={email:n,rating:H.get(e,i),counter:l>=5?k.get(e,i+1):void 0};break}case"GEOB":{c=m(e,i+1,d,s);let n=h(e.slice(i+1,c),f);i=c+1,c=m(e,i,d,s);let l=h(e.slice(i,c),f);i=c+1,c=m(e,i,d,s);let u=h(e.slice(i,c),f);i=c+1,o={type:n,filename:l,description:u,data:e.slice(i,d)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":c=m(e,i+1,d,s),o=h(e.slice(i,c),f);break;case"WXXX":{c=m(e,i+1,d,s);let n=h(e.slice(i+1,c),s);i=c+(s==="utf-16le"?2:1),o={description:n,url:h(e.slice(i,d),f)};break}case"WFD":case"WFED":o=h(e.slice(i+1,m(e,i+1,d,s)),s);break;case"MCDI":{o=e.slice(0,d);break}default:U(`Warning: unsupported id3v2-tag-type: ${t}`);break}return o}static readNullTerminatedString(e,t){let a=t.bom?2:0,s=m(e,a,e.length,t.encoding),g=e.slice(a,s);return t.encoding==="utf-16le"?a=s+2:a=s+1,{text:h(g,t.encoding),len:a}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase(),e){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){let t={};for(let a=0;a+1<e.length;a+=2){let s=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(s):s}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),r.trimArray(a)}static trimArray(e){return e.map(t=>t.replace(/\x00+$/,"").trim())}static readIdentifierAndData(e,t,a,s){let g=m(e,t,a,s),d=h(e.slice(t,g),s);return t=g+r.getNullTerminatorLength(s),{id:d,data:e.slice(t,a)}}static getNullTerminatorLength(e){return e==="utf-16le"?2:1}},x=class extends E("id3v2"){};function K(r){throw new x(`Unexpected majorVer: ${r}`)}var j=new TextDecoder("ascii"),O=class r{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=e[t]===255&&e[t+1]===0?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.slice(0,a)}static getFrameHeaderLength(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw C(e)}}static readFrameFlags(e){return{status:{tag_alter_preservation:p(e,0,6),file_alter_preservation:p(e,0,5),read_only:p(e,0,4)},format:{grouping_identity:p(e,1,7),compression:p(e,1,3),encryption:p(e,1,2),unsynchronisation:p(e,1,1),data_length_indicator:p(e,1,0)}}}static readFrameData(e,t,a,s,g){let d=new I(a,g);switch(a){case 2:return d.readData(e,t.id,s);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=r.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.slice(4,e.length)),d.readData(e,t.id,s);default:throw C(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}parse(e,t,a){return T(this,null,function*(){this.tokenizer=t,this.metadata=e,this.options=a;let s=yield this.tokenizer.readToken(B);if(s.fileIdentifier!=="ID3")throw new x("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=s,this.headerType=`ID3v2.${s.version.major}`,s.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(s.size)})}parseExtendedHeader(){return T(this,null,function*(){let e=yield this.tokenizer.readToken(S),t=e.size-S.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)})}parseExtendedHeaderData(e,t){return T(this,null,function*(){return yield this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)})}parseId3Data(e){return T(this,null,function*(){let t=yield this.tokenizer.readToken(new b(e));for(let a of this.parseMetadata(t))switch(a.id){case"TXXX":a.value&&(yield this.handleTag(a,a.value.text,()=>a.value.description));break;default:yield Array.isArray(a.value)?Promise.all(a.value.map(s=>this.addTag(a.id,s))):this.addTag(a.id,a.value)}})}handleTag(e,t,a,s=g=>g){return T(this,null,function*(){yield Promise.all(t.map(g=>this.addTag(r.makeDescriptionTagName(e.id,a(g)),s(g))))})}addTag(e,t){return T(this,null,function*(){yield this.metadata.addTag(this.headerType,e,t)})}parseMetadata(e){let t=0,a=[];for(;t!==e.length;){let s=r.getFrameHeaderLength(this.id3Header.version.major);if(t+s>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}let g=e.slice(t,t+s);t+=s;let d=this.readFrameHeader(g,this.id3Header.version.major),i=e.slice(t,t+d.length);t+=d.length;let o=r.readFrameData(i,d,this.id3Header.version.major,!this.options.skipCovers,this.metadata);o&&a.push({id:d.id,value:o})}return a}readFrameHeader(e,t){let a;switch(t){case 2:a={id:j.decode(e.slice(0,3)),length:P.get(e,3)},a.id.match(/[A-Z0-9]{3}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${a.id}`);break;case 3:case 4:a={id:j.decode(e.slice(0,4)),length:(t===4?$:k).get(e,4),flags:r.readFrameFlags(e.slice(8,10))},a.id.match(/[A-Z0-9]{4}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${a.id}`);break;default:throw C(t)}return a}};function C(r){throw new x(`Unexpected majorVer: ${r}`)}export{O as a};
